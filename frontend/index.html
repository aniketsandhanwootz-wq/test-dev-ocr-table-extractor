<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bulk Upload - Columns</title>
  <link rel="stylesheet" href="style.css">

  <!-- Handsontable CSS and JS from CDN -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
  
  <style>
    .secondary-button {
      background-color: #ccc;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .secondary-button:hover {
      opacity: 0.8;
    }
    .upload-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    }
    .upload-row input[type="file"] {
      width: 180px;
    }
    /* highlight user-edited cells */
    .edited-cell {
      box-shadow: inset 0 0 0 2px orange !important;
    }
    
/*    New UI Chnages */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #333;
    }
    header {
      background: #004080;
      color: #fff;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    header .logo {
      height: 40px;
      width: 40px;
    }
    header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    header .instructions {
      margin-left: auto;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .upload‚Äêgrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .upload‚Äêarea {
      position: relative;
      border: 2px dashed #bbb;
      border-radius: 6px;
      padding: 1rem;
      text-align: center;
      background: #fafafa;
      transition: border-color .2s, background .2s;
      cursor: pointer;
    }
    .upload‚Äêarea.dragover {
      border-color: #007bff;
      background: #e6f0ff;
    }
    .upload‚Äêarea .upload‚Äêicon {
      font-size: 2rem;
      color: #777;
    }
    .upload‚Äêarea p {
      margin: .5rem 0 0;
      font-size: .95rem;
    }
    .upload‚Äêarea .required {
      color: #d00;
      margin-left: 2px;
    }
    .upload‚Äêarea input[type=file] {
      display: none;
    }
    .upload‚Äêarea .preview {
      margin-top: .5rem;
    }
    .upload‚Äêarea .preview img {
      max-width: 100%;
      max-height: 100px;
      border-radius: 4px;
    }
    .upload‚Äêarea .remove‚Äêbtn {
      position: absolute;
      top: 4px; right: 4px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px; height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .upload‚Äêarea.has‚Äêfile .remove‚Äêbtn {
      display: flex;
    }

    #process-btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: .75rem 1.5rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      opacity: .5;
    }
    #process-btn.enabled {
      opacity: 1;
    }
    #process-btn:disabled {
      cursor: not-allowed;
    }
  </style>
</head>
<body>
<!--   New UI Code -->
  <header>
    <img src="logo.png" alt="Tool Logo" class="logo">
    <h1>Bulk Upload ‚Äì Columns</h1>
    <div class="instructions">
      Take screenshot of a column and upload in its box.<br>
      Required fields are marked with <span style="color:#d00">*</span>
    </div>
  </header>
<!-- UI Code End -->
  
  <div class="container">
    <div class="upload‚Äêgrid">
      <!-- Part Number -->
      <div class="upload‚Äêarea" id="area‚ÄêpartNumber" data‚Äêfield="partNumber">
        <i class="upload‚Äêicon">üì∑</i>
        <p>Part Number <span class="required">*</span></p>
        <input type="file" id="upload‚Äêpartnumber" accept="image/*">
        <div class="preview"></div>
        <button class="remove‚Äêbtn">&times;</button>
      </div>
      <!-- Quantity -->
      <div class="upload‚Äêarea" id="area‚Äêquantity" data‚Äêfield="quantity">
        <i class="upload‚Äêicon">üì∑</i>
        <p>Quantity <span class="required">*</span></p>
        <input type="file" id="upload‚Äêquantity" accept="image/*">
        <div class="preview"></div>
        <button class="remove‚Äêbtn">&times;</button>
      </div>
      <!-- Description -->
      <div class="upload‚Äêarea" id="area‚Äêdescription" data‚Äêfield="description">
        <i class="upload‚Äêicon">üì∑</i>
        <p>Description</p>
        <input type="file" id="upload‚Äêdescription" accept="image/*">
        <div class="preview"></div>
        <button class="remove‚Äêbtn">&times;</button>
      </div>
      <!-- Material -->
      <div class="upload‚Äêarea" id="area‚Äêmaterial" data‚Äêfield="material">
        <i class="upload‚Äêicon">üì∑</i>
        <p>Material</p>
        <input type="file" id="upload‚Äêmaterial" accept="image/*">
        <div class="preview"></div>
        <button class="remove‚Äêbtn">&times;</button>
      </div>
    </div>

    <button id="process-btn" disabled>Process Images</button>
<!--     <h1>Extract Drawing info</h1>

    <select id="mode-select">
      <option value="table" selected>Column-by-Column Table Extract</option>
      <option value="quick">Quick Text Copy (Paragraph)</option>
    </select>

    <h3 style="margin-bottom: 6px;">Upload Column Data</h3>
    
    <div class="upload-row">
      <label>Select PartNumber (Required)</label>
      <input type="file" id="upload-partnumber" accept="image/*" />
    </div>
    
    <div class="upload-row">
      <label>Select Description (Optional)</label>
      <input type="file" id="upload-description" accept="image/*" />
    </div>

    <div class="upload-row">
      <label>Select Quantity (Required)</label>
      <input type="file" id="upload-quantity" accept="image/*" />
    </div>
    
    <div class="upload-row">
      <label>Select Material (Optional)</label>
      <input type="file" id="upload-material" accept="image/*" />
    </div>

    <div id="image-preview"></div>
    <button id="process-btn">Process Image</button>

    <div id="result-container"></div>
    <button id="download-btn" class="secondary-button" style="display: none;">Download as CSV</button>
    <div id="hot" style="width: 100%; height: 400px; display: none;"></div> -->
    
  </div>

  <script>

// New UI code 
  // ‚Äî‚Äî UI: drag & drop + preview + button enable/disable ‚Äî‚Äî //
  const processBtn = document.getElementById('process-btn');
  const requiredCols = ['partNumber','quantity'];
  
  function updateProcessButton() {
    const ok = requiredCols.every(id => uploads[id].files.length > 0);
    processBtn.disabled = !ok;
  }
  
  // build upload-area behavior
  document.querySelectorAll('.upload-area').forEach(area => {
    const col = area.dataset.column;
    const input = area.querySelector('input[type=file]');
    const preview = area.querySelector('.upload-preview');
  
    // click anywhere
    area.addEventListener('click', () => input.click());
  
    // when file selected via dialog
    input.addEventListener('change', () => {
      showUploadPreview(col, input.files[0], preview);
      updateProcessButton();
    });
  
    // drag-over highlight
    area.addEventListener('dragover', e => {
      e.preventDefault();
      area.classList.add('dragover');
    });
    ['dragleave','drop'].forEach(ev => {
      area.addEventListener(ev, () => area.classList.remove('dragover'));
    });
  
    // handle drop
    area.addEventListener('drop', e => {
      e.preventDefault();
      if (e.dataTransfer.files.length) {
        input.files = e.dataTransfer.files;
        showUploadPreview(col, input.files[0], preview);
        updateProcessButton();
      }
    });
  });
  
  function showUploadPreview(col, file, previewEl) {
    previewEl.innerHTML = '';
    const reader = new FileReader();
    reader.onload = evt => {
      const img = document.createElement('img');
      img.src = evt.target.result;
      const btn = document.createElement('button');
      btn.innerText = '√ó';
      btn.className = 'remove-btn';
      btn.addEventListener('click', e => {
        e.stopPropagation();
        previewEl.innerHTML = '';
        uploads[col].value = '';         // clear the input
        updateProcessButton();
      });
      previewEl.appendChild(img);
      previewEl.appendChild(btn);
    };
    reader.readAsDataURL(file);
  }
  
  // initially disable the button
  processBtn.disabled = true;
// New UI code end

    // :-----------------------------------------:
    //  Column key ‚Üí display title mapping
    // :-----------------------------------------:
    const COLUMN_TITLES = {
      PartNumber:            "Part Number",
      Quantity:              "Quantity",
      Description:           "Description",
      Material:              "Material",
      "Matched Childpart":   "Matched Drawing Number",
      Type:                  "Type"
    };
    
    let spreadsheetData = [];
    let columnsList = [];
    let columnCount = 0;
    let hot;

    const uploads = {
      partNumber: document.getElementById("upload-partnumber"),
      description: document.getElementById("upload-description"),
      quantity: document.getElementById("upload-quantity"),
      material: document.getElementById("upload-material")
    };

    const columnOrder = [
      { id: "partNumber", label: "PartNumber" },
      { id: "description", label: "Description" },
      { id: "quantity", label: "Quantity" },
      { id: "material", label: "Material" }
    ];

    const API_URL = 'https://ocr-table-extractor.onrender.com';

    window.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const project = urlParams.get("project");
      const partNumber = urlParams.get("part");
      const parentDrgNum = urlParams.get("parentdrgnum");

      if (!project || !partNumber || !parentDrgNum) {
        alert("Missing query params: project or part or parent drawing number");
        return;
      }

      try {
        const response = await fetch("https://ocr-table-extractor.onrender.com/fetch-drawings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project, part: partNumber })
        });
        const data = await response.json();
        console.log("‚úÖ Filtered drawing data from Glide via backend:", data.rows);
        window.childParts = data.rows;
      } catch (err) {
        console.error("‚ùå Error fetching drawing data:", err);
      }
    });

    function textRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      const rowData = instance.getSourceDataAtRow(row);
      if (rowData && rowData[prop] && typeof rowData[prop] === 'object') {
        const cellData = rowData[prop];
        td.innerText = cellData.text;
        const conf = parseFloat(cellData.confidence);
        if (conf >= 0.9) td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
        else if (conf >= 0.7) td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
        else td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
      } else {
        td.innerText = value;
      }
    }

    function renderSpreadsheet() {
      // ensure the new column is in the right spot
      if (columnsList.includes("Matched Childpart") && !columnsList.includes("Type")) {
        const idx = columnsList.indexOf("Matched Childpart");
        columnsList.splice(idx + 1, 0, "Type");
      }
      
      const columns = [];
      const colHeaders = [];
    
      columnsList.forEach(key => {
        const title = COLUMN_TITLES[key] || key;
        const isMatched = key === 'Matched Childpart';
        const isType    = key === "Type";
        const drawingOptions = Array.isArray(window.childParts)
          ? window.childParts.map(p => p.drawingNumber || '')
          : [];
    
        columns.push({
          // 1) editor & data binding
          data:       (isMatched || isType) ? key : `${key}.text`,
          title,
          type:       (isMatched || isType) ? 'dropdown' : 'text',
          editor:     (isMatched || isType) ? 'dropdown' : 'text',
          source:     isMatched ? drawingOptions : isType ? ['Child Part','BO'] : undefined,
          strict:     (isMatched || isType),
          allowInvalid: false,
    
          // 2) custom renderer for OCR columns
          renderer: (isMatched || isType)
            ? undefined
            : function(hotInst, td, row, col, prop, value, cellProps) {
                // first draw the text
                Handsontable.renderers.TextRenderer.apply(this, arguments);
    
                // then pull the original object back out
                const rowData = hotInst.getSourceDataAtRow(row);
                const cellObj = rowData[key];  // the {text, confidence} you stored
    
                if (cellObj && typeof cellObj === 'object') {
                  const conf = parseFloat(cellObj.confidence);
                  if (conf >= 0.9) {
                    td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                  } else if (conf >= 0.7) {
                    td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
                  } else {
                    td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
                  }
                }
              }
        });
    
        colHeaders.push(key);
      });
    
      const container = document.getElementById('hot');
      container.style.display = 'block';
    
      if (hot) hot.destroy();
      hot = new Handsontable(container, {
        data: spreadsheetData,
        columns,
        colHeaders,
        rowHeaders: true,
        minSpareRows: 1,
        contextMenu: ['remove_row','copy','paste'],
        licenseKey: 'non-commercial-and-evaluation'
      });
      
      // after you create `hot` in renderSpreadsheet():
      hot.addHook('afterChange', (changes, source) => {
        // only care about real user edits
        if (source !== 'edit' || !changes) return;
      
        changes.forEach(([row, prop, oldValue, newValue]) => {
          // skip if value didn‚Äôt actually change
          if (oldValue === newValue) return;
      
          const col = hot.propToCol(prop);
          // mark this cell as edited
          hot.setCellMeta(row, col, 'className', 'edited-cell');
        });
      
        // re-render so every flagged cell gets the CSS
        hot.render();
      });
      
      // hot.addHook('afterChange', (changes, source) => {
      //   if (source !== 'edit' || !changes) return;
      //   changes.forEach(([row, prop /*, oldValue, newValue */]) => {
      //     const col = hot.propToCol(prop);
      //     const cell = hot.getCell(row, col);
      //     if (cell) {
      //       cell.classList.add('edited-cell');
      //     }
      //   });
      // });
    }

    

    function addColumn(newColumnData, label) {
      columnsList.push(label);
      if (label === "PartNumber" && !columnsList.includes("Matched Childpart")) {
        columnsList.push("Matched Childpart");
        columnsList.push("Type");
      }

      for (let i = 0; i < newColumnData.length; i++) {
        const text = newColumnData[i].text || "";
        const confidence = newColumnData[i].confidence || 0;
        if (!spreadsheetData[i]) spreadsheetData[i] = {};
        spreadsheetData[i][label] = { text, confidence };

        if (label === "PartNumber" && window.childParts?.length) {
          const drawingNumbers = window.childParts.map(p => p.drawingNumber || "");
          const result = stringSimilarity.findBestMatch(text, drawingNumbers);
          const matchText = result.bestMatch.rating > 0.5 ? result.bestMatch.target : "";
          // spreadsheetData[i]["Matched Childpart"] = { text: matchText, confidence: result.bestMatch.rating };
          spreadsheetData[i]["Matched Childpart"] = matchText; // Just plain string
          // Type cell: auto‚Äêpopulate
          // only set Type if there's actually a PartNumber
          if (text) {
            spreadsheetData[i]["Type"] = matchText ? "Child Part" : "BO";
          }
        }

        for (let i = newColumnData.length; i < spreadsheetData.length; i++) {
          // only if there's really a PartNumber in that row
          const part = spreadsheetData[i]["PartNumber"]?.text;
          if (part) {
            const hasMatch = spreadsheetData[i]["Matched Childpart"]?.text;
            spreadsheetData[i]["Type"] = hasMatch ? "Child Part" : "BO";
          }
       }
      }

      renderSpreadsheet();
    }

    document.getElementById("process-btn").onclick = async function () {
      spreadsheetData = [];
      columnsList = [];
      columnCount = 0;

      for (const col of columnOrder) {
        const fileInput = uploads[col.id];
        const file = fileInput.files[0];
        if (!file && (col.id === "partNumber" || col.id === "quantity")) {
          alert(`Please upload an image for ${col.label}`);
          return;
        }
        if (!file) continue;

        const formData = new FormData();
        formData.append("image", file);
        formData.append("mode", "table");

+       // Log & tell the backend which column we‚Äôre OCR‚Äôing
+       console.log(`üöÄ OCR request for column: ${col.id}`);
+       formData.append("column", col.id);

        const response = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        if (data.table) {
          addColumn(data.table, col.label);
        }
      }
    };

    const previewContainer = document.getElementById("image-preview");

    // // Preview function
    // function showImagePreview(file, label) {
    //   const reader = new FileReader();
    //   reader.onload = function (event) {
    //     const img = new Image();
    //     img.src = event.target.result;
    //     img.style.maxWidth = "300px";
    //     img.alt = label;
    
    //     // Clear previous preview and insert new one
    //     previewContainer.innerHTML = `<strong>${label}</strong><br>`;
    //     previewContainer.appendChild(img);
    //   };
    //   reader.readAsDataURL(file);
    // }
    
    // // Attach onchange handlers
    // uploads.partNumber.addEventListener("change", (e) => {
    //   if (e.target.files[0]) showImagePreview(e.target.files[0], "PartNumber Preview");
    // });
    // uploads.quantity.addEventListener("change", (e) => {
    //   if (e.target.files[0]) showImagePreview(e.target.files[0], "Quantity Preview");
    // });
    // uploads.description.addEventListener("change", (e) => {
    //   if (e.target.files[0]) showImagePreview(e.target.files[0], "Description Preview");
    // });
    // uploads.material.addEventListener("change", (e) => {
    //   if (e.target.files[0]) showImagePreview(e.target.files[0], "Material Preview");
    // });
    
  </script>
</body>
</html>
