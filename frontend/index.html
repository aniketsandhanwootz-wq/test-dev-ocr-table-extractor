<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OCR Table Extractor</title>
  <link rel="stylesheet" href="style.css">

  <!-- Handsontable CSS and JS from CDN -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>OCR Table Extractor</h1>

    <select id="mode-select">
      <option value="quick">Quick Text Copy (Paragraph)</option>
      <option value="table">Column-by-Column Table Extract</option>
    </select>

    <input type="file" id="image-upload" accept="image/png, image/jpeg" />
    <div id="image-preview"></div>
    <button id="process-btn">Process Image</button>

    <!-- Container for non-spreadsheet results -->
    <div id="result-container"></div>
    <!-- Container for Handsontable spreadsheet (hidden by default) -->
    <div id="hot" style="width: 100%; height: 400px; display: none;"></div>

    <button id="download-btn" style="display: none;">Download Result</button>
  </div>

  <script>
    // Preview the selected image
    document.getElementById('image-upload').onchange = function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.src = event.target.result;
        img.style.maxWidth = '300px';
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        preview.appendChild(img);
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    // Custom renderer for Handsontable to apply conditional formatting based on confidence
    function confidenceRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      // Only apply coloring for the "confidence" column (assumed numeric)
      if (value >= 0.9) {
        td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)'; // Green
      } else if (value >= 0.8) {
        td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)'; // Orange
      } else {
        td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';  // Red
      }
    }

    // Function to initialize and render Handsontable spreadsheet
    function renderSpreadsheet(data) {
      // Show the Handsontable container and hide the generic result container
      document.getElementById('hot').style.display = 'block';
      document.getElementById('result-container').innerHTML = '';

      // Initialize Handsontable
      const container = document.getElementById('hot');
      const hot = new Handsontable(container, {
        data: data, // data should be an array of objects: { text: "ABC", confidence: 0.95 }
        columns: [
          { data: 'text', title: 'Text', type: 'text' },
          { data: 'confidence', title: 'Confidence', type: 'numeric', renderer: confidenceRenderer }
        ],
        colHeaders: true,
        rowHeaders: true,
        minSpareRows: 1, // Always provide an extra row for adding new data
        contextMenu: true,
        licenseKey: 'non-commercial-and-evaluation'
      });

      // Attach download functionality to export the spreadsheet as CSV
      document.getElementById('download-btn').onclick = function () {
        const csv = Handsontable.helper.stringify(hot.getData());
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "extracted_table.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
    }

    // Process button handler
    document.getElementById('process-btn').onclick = async function () {
      const imageInput = document.getElementById('image-upload');
      const mode = document.getElementById('mode-select').value;
      const resultContainer = document.getElementById('result-container');

      if (!imageInput.files[0]) {
        alert("Please upload an image first!");
        return;
      }

      // Check file size (limit to 2MB for example)
      const fileSizeMB = imageInput.files[0].size / (1024 * 1024);
      if (fileSizeMB > 2) {
        alert(`Image size (${fileSizeMB.toFixed(2)}MB) is too large. Please use an image under 2MB.`);
        return;
      }

      resultContainer.innerHTML = '<div class="loading">Processing... This may take up to 30 seconds.</div>';

      const formData = new FormData();
      formData.append('image', imageInput.files[0]);
      formData.append('mode', mode);

      try {
        // Replace with your actual backend URL (e.g., on Render)
        const API_URL = 'https://ocr-table-extractor.onrender.com';
        
        // Test API endpoint (optional)
        const testResponse = await fetch(`${API_URL}/test`);
        if (!testResponse.ok) {
          throw new Error(`API test failed with status: ${testResponse.status}`);
        }

        // Set a timeout for the main request (60 seconds)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);

        const response = await fetch(API_URL, {
          method: 'POST',
          body: formData,
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error (${response.status}): ${errorText}`);
        }

        const data = await response.json();

        // For "table" mode, use Handsontable to display an editable spreadsheet.
        if (mode === "table" && data.table) {
          renderSpreadsheet(data.table);
        } else if (mode === "quick" && data.extracted_text) {
          resultContainer.innerHTML = `
            <h3>Extracted Text:</h3>
            <div class="extracted-text">${data.extracted_text.replace(/\n/g, '<br>')}</div>
          `;
        } else {
          resultContainer.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        document.getElementById('download-btn').style.display = 'block';
      } catch (error) {
        if (error.name === 'AbortError') {
          resultContainer.innerHTML = '<p class="error">Request timed out. Try a smaller image or try again later.</p>';
        } else {
          resultContainer.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        }
        console.error('Error details:', error);
      }
    };
  </script>
</body>
</html>
