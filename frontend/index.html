<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extract Drawing info</title>
  <link rel="stylesheet" href="style.css">

  <!-- Handsontable CSS and JS from CDN -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
  
  <style>
    .secondary-button {
      background-color: #ccc;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .secondary-button:hover {
      opacity: 0.8;
    }
    .upload-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    }
    .upload-row input[type="file"] {
      width: 180px;
    }
    /* highlight user-edited cells */
    .edited-cell {
      box-shadow: inset 0 0 0 2px orange !important;
    }
   
  </style>
</head>
<body>
  <div class="container">
    <h1>Extract Drawing info</h1>

    <select id="mode-select">
      <option value="table" selected>Column-by-Column Table Extract</option>
      <option value="quick">Quick Text Copy (Paragraph)</option>
    </select>

    <h3 style="margin-bottom: 6px;">Upload Column Data</h3>
    
    <div class="upload-row">
      <label>Select PartNumber (Required)</label>
      <input type="file" id="upload-partnumber" accept="image/*" />
    </div>
    
    <div class="upload-row">
      <label>Select Description (Optional)</label>
      <input type="file" id="upload-description" accept="image/*" />
    </div>

    <div class="upload-row">
      <label>Select Quantity (Required)</label>
      <input type="file" id="upload-quantity" accept="image/*" />
    </div>
    
    <div class="upload-row">
      <label>Select Material (Optional)</label>
      <input type="file" id="upload-material" accept="image/*" />
    </div>

    <div id="image-preview"></div>
    <button id="process-btn">Process Image</button>

    <div id="result-container"></div>
    <button id="download-btn" class="secondary-button" style="display: none;">Download as CSV</button>
    <div id="hot" style="width: 100%; height: 400px; display: none;"></div>
    
  </div>

  <script>
    let spreadsheetData = [];
    let columnsList = [];
    let columnCount = 0;
    let hot;

    const uploads = {
      partNumber: document.getElementById("upload-partnumber"),
      description: document.getElementById("upload-description"),
      quantity: document.getElementById("upload-quantity"),
      material: document.getElementById("upload-material")
    };

    const columnOrder = [
      { id: "partNumber", label: "PartNumber" },
      { id: "description", label: "Description" },
      { id: "quantity", label: "Quantity" },
      { id: "material", label: "Material" }
    ];

    const API_URL = 'https://ocr-table-extractor.onrender.com';

    window.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const project = urlParams.get("project");
      const partNumber = urlParams.get("part");
      const parentDrgNum = urlParams.get("parentdrgnum");

      if (!project || !partNumber || !parentDrgNum) {
        alert("Missing query params: project or part or parent drawing number");
        return;
      }

      try {
        const response = await fetch("https://ocr-table-extractor.onrender.com/fetch-drawings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project, part: partNumber })
        });
        const data = await response.json();
        console.log("✅ Filtered drawing data from Glide via backend:", data.rows);
        window.childParts = data.rows;
      } catch (err) {
        console.error("❌ Error fetching drawing data:", err);
      }
    });

    function textRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      const rowData = instance.getSourceDataAtRow(row);
      if (rowData && rowData[prop] && typeof rowData[prop] === 'object') {
        const cellData = rowData[prop];
        td.innerText = cellData.text;
        const conf = parseFloat(cellData.confidence);
        if (conf >= 0.9) td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
        else if (conf >= 0.7) td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
        else td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
      } else {
        td.innerText = value;
      }
    }

function renderSpreadsheet() {
  const columns = [];
  const colHeaders = [];

  columnsList.forEach(key => {
    const isMatched = key === 'Matched Childpart';
    const drawingOptions = Array.isArray(window.childParts)
      ? window.childParts.map(p => p.drawingNumber || '')
      : [];

    columns.push({
      // 1) editor & data binding
      data:       isMatched ? key : `${key}.text`,
      type:       isMatched ? 'dropdown' : 'text',
      editor:     isMatched ? 'dropdown' : 'text',
      source:     isMatched ? drawingOptions : undefined,
      strict:     isMatched,
      allowInvalid: false,

      // 2) custom renderer for OCR columns
      renderer: isMatched
        ? undefined
        : function(hotInst, td, row, col, prop, value, cellProps) {
            // first draw the text
            Handsontable.renderers.TextRenderer.apply(this, arguments);

            // then pull the original object back out
            const rowData = hotInst.getSourceDataAtRow(row);
            const cellObj = rowData[key];  // the {text, confidence} you stored

            if (cellObj && typeof cellObj === 'object') {
              const conf = parseFloat(cellObj.confidence);
              if (conf >= 0.9) {
                td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
              } else if (conf >= 0.7) {
                td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
              } else {
                td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
              }
            }
          }
    });

    colHeaders.push(key);
  });

  const container = document.getElementById('hot');
  container.style.display = 'block';

  if (hot) hot.destroy();
  hot = new Handsontable(container, {
    data: spreadsheetData,
    columns,
    colHeaders,
    rowHeaders: true,
    minSpareRows: 1,
    contextMenu: ['remove_row','copy','paste'],
    licenseKey: 'non-commercial-and-evaluation'
  });
  
  // after you create `hot` in renderSpreadsheet():
  hot.addHook('afterChange', (changes, source) => {
    if (source !== 'edit' || !changes) return;
  
    changes.forEach(([row, prop /*, oldValue, newValue */]) => {
      const col = hot.propToCol(prop);
      // set the CSS class meta on the cell
      hot.setCellMeta(row, col, 'className', 'edited-cell');
    });
  
    // re-draw so you can see all flagged cells
    hot.render();
  });
  
  // hot.addHook('afterChange', (changes, source) => {
  //   if (source !== 'edit' || !changes) return;
  //   changes.forEach(([row, prop /*, oldValue, newValue */]) => {
  //     const col = hot.propToCol(prop);
  //     const cell = hot.getCell(row, col);
  //     if (cell) {
  //       cell.classList.add('edited-cell');
  //     }
  //   });
  // });
}

    

    function addColumn(newColumnData, label) {
      columnsList.push(label);
      if (label === "PartNumber" && !columnsList.includes("Matched Childpart")) {
        columnsList.push("Matched Childpart");
      }

      for (let i = 0; i < newColumnData.length; i++) {
        const text = newColumnData[i].text || "";
        const confidence = newColumnData[i].confidence || 0;
        if (!spreadsheetData[i]) spreadsheetData[i] = {};
        spreadsheetData[i][label] = { text, confidence };

        if (label === "PartNumber" && window.childParts?.length) {
          const drawingNumbers = window.childParts.map(p => p.drawingNumber || "");
          const result = stringSimilarity.findBestMatch(text, drawingNumbers);
          const matchText = result.bestMatch.rating > 0.5 ? result.bestMatch.target : "";
          // spreadsheetData[i]["Matched Childpart"] = { text: matchText, confidence: result.bestMatch.rating };
          spreadsheetData[i]["Matched Childpart"] = matchText; // Just plain string
        }
      }

      renderSpreadsheet();
    }

    document.getElementById("process-btn").onclick = async function () {
      spreadsheetData = [];
      columnsList = [];
      columnCount = 0;

      for (const col of columnOrder) {
        const fileInput = uploads[col.id];
        const file = fileInput.files[0];
        if (!file && (col.id === "partNumber" || col.id === "quantity")) {
          alert(`Please upload an image for ${col.label}`);
          return;
        }
        if (!file) continue;

        const formData = new FormData();
        formData.append("image", file);
        formData.append("mode", "table");

        const response = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        if (data.table) {
          addColumn(data.table, col.label);
        }
      }
    };

    const previewContainer = document.getElementById("image-preview");

    // Preview function
    function showImagePreview(file, label) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.src = event.target.result;
        img.style.maxWidth = "300px";
        img.alt = label;
    
        // Clear previous preview and insert new one
        previewContainer.innerHTML = `<strong>${label}</strong><br>`;
        previewContainer.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
    
    // Attach onchange handlers
    uploads.partNumber.addEventListener("change", (e) => {
      if (e.target.files[0]) showImagePreview(e.target.files[0], "PartNumber Preview");
    });
    uploads.quantity.addEventListener("change", (e) => {
      if (e.target.files[0]) showImagePreview(e.target.files[0], "Quantity Preview");
    });
    uploads.description.addEventListener("change", (e) => {
      if (e.target.files[0]) showImagePreview(e.target.files[0], "Description Preview");
    });
    uploads.material.addEventListener("change", (e) => {
      if (e.target.files[0]) showImagePreview(e.target.files[0], "Material Preview");
    });
    
  </script>
</body>
</html>
